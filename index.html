<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Extraction Field Classifier</title>
    <!-- jQuery CDN -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .buttons {
            display: flex;
            gap: 10px;
        }
        button {
            padding: 10px 15px;
            cursor: pointer;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Data Extraction Field Classifier</h1>
        
        <div>
            <h2>Step 1: Load Metadata CSV</h2>
            <input type="file" id="metadata-file" accept=".csv">
        </div>
        
        <div>
            <h2>Step 2: Enter Field Names</h2>
            <p>Enter one field name per line:</p>
            <textarea id="field-names" placeholder="id&#10;name&#10;credit_score"></textarea>
            <div class="buttons">
                <button id="process-btn">Process Fields</button>
            </div>
        </div>
        
        <div id="results-section" class="hidden">
            <h2>Results</h2>
            <table id="results-table">
                <thead>
                    <tr>
                        <th>Table</th>
                        <th>Field Name</th>
                        <th>Path</th>
                        <th>Classification</th>
                        <th>PI</th>
                        <th>PCI</th>
                        <th>Treatment</th>
                    </tr>
                </thead>
                <tbody id="results-body"></tbody>
            </table>
            <div class="buttons">
                <button id="export-btn">Export Results</button>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            let metadataData = [];
            
            // Load and parse CSV file
            $('#metadata-file').on('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    metadataData = parseCSV(content);
                    alert('Metadata loaded successfully!');
                };
                reader.readAsText(file);
            });
            
            // Process field names
            $('#process-btn').on('click', function() {
                if (metadataData.length === 0) {
                    alert('Please load metadata CSV first!');
                    return;
                }
                
                const fieldNamesText = $('#field-names').val();
                const fieldNames = fieldNamesText.split('\n').filter(name => name.trim() !== '');
                
                if (fieldNames.length === 0) {
                    alert('Please enter at least one field name!');
                    return;
                }
                
                processFields(fieldNames);
                $('#results-section').removeClass('hidden');
            });
            
            // Export results
            $('#export-btn').on('click', function() {
                const rows = $('#results-table tbody tr').get();
                
                if (rows.length === 0) {
                    alert('No results to export!');
                    return;
                }
                
                const csvContent = exportToCSV(rows);
                downloadCSV(csvContent, 'classified_fields.csv');
            });
            
            // Parse CSV content
            function parseCSV(content) {
                const lines = content.split('\n');
                const headers = lines[0].split(',');
                
                return lines.slice(1)
                    .filter(line => line.trim() !== '')
                    .map(line => {
                        const values = line.split(',');
                        const obj = {};
                        
                        headers.forEach((header, i) => {
                            obj[header.trim()] = values[i] ? values[i].trim() : '';
                        });
                        
                        return obj;
                    });
            }
            
            // Process field names and display results
            function processFields(fieldNames) {
                const $resultsBody = $('#results-body');
                $resultsBody.empty();
                
                fieldNames.forEach(fieldName => {
                    // Find all matching fields
                    const matchingFields = metadataData.filter(item => 
                        item.object_type === 'field' && item.name === fieldName.trim()
                    );
                    
                    if (matchingFields.length === 0) {
                        // No match found
                        $resultsBody.append(`
                            <tr>
                                <td>-</td>
                                <td>${fieldName}</td>
                                <td colspan="5">No matching field found</td>
                            </tr>
                        `);
                    } else if (matchingFields.length === 1) {
                        // Single match found
                        $resultsBody.append(createResultRow(matchingFields[0], fieldName));
                    } else {
                        // Multiple matches found - create dropdown
                        $resultsBody.append(createResultRow(matchingFields[0], fieldName, matchingFields));
                    }
                });
            }
            
            // Create result row
            function createResultRow(field, fieldName, matchingFields = null) {
                if (matchingFields) {
                    // Multiple matches - create row with dropdown
                    const $row = $('<tr>').attr('data-field-name', fieldName);
                    
                    // Extract table names for dropdown
                    const tableOptions = matchingFields.map((f, i) => {
                        const pathParts = f.path.split('/');
                        const tableName = pathParts[pathParts.length - 2];
                        return `<option value="${i}">${tableName}</option>`;
                    }).join('');
                    
                    // Create table cell with dropdown
                    const $tableCell = $('<td>').append(
                        $('<select>').html(tableOptions).on('change', function() {
                            const selectedIndex = parseInt($(this).val());
                            updateRowData($row, matchingFields[selectedIndex]);
                        })
                    );
                    
                    // Add all cells to row
                    $row.append($tableCell)
                        .append(`<td>${fieldName}</td>`)
                        .append('<td></td><td></td><td></td><td></td><td></td>');
                    
                    // Initialize with first match
                    updateRowData($row, field);
                    
                    return $row;
                } else {
                    // Single match - create simple row
                    const pathParts = field.path.split('/');
                    const tableName = pathParts[pathParts.length - 2];
                    
                    return $('<tr>')
                        .attr('data-field-name', fieldName)
                        .append(`<td>${tableName}</td>`)
                        .append(`<td>${fieldName}</td>`)
                        .append(`<td>${field.path}</td>`)
                        .append(`<td>${field.classification}</td>`)
                        .append(`<td>${field.pi}</td>`)
                        .append(`<td>${field.pci}</td>`)
                        .append(`<td>${field.treatment}</td>`);
                }
            }
            
            // Update row data when table selection changes
            function updateRowData($row, field) {
                const $cells = $row.find('td');
                
                // Update cells (skip first two - table dropdown and field name)
                $cells.eq(2).text(field.path);
                $cells.eq(3).text(field.classification);
                $cells.eq(4).text(field.pi);
                $cells.eq(5).text(field.pci);
                $cells.eq(6).text(field.treatment);
            }
            
            // Export table to CSV
            function exportToCSV(rows) {
                let csvContent = 'object_type,name,path,classification,pi,pci,treatment\n';
                
                $(rows).each(function() {
                    const $row = $(this);
                    const fieldName = $row.data('field-name');
                    const $cells = $row.find('td');
                    
                    // Skip rows with no matching field
                    if ($cells.eq(2).attr('colspan') === '5') return;
                    
                    // Get table name (either from dropdown or text)
                    const $tableCell = $cells.eq(0);
                    const tableName = $tableCell.find('select').length > 0 
                        ? $tableCell.find('select option:selected').text() 
                        : $tableCell.text();
                    
                    csvContent += `field,${fieldName},${$cells.eq(2).text()},${$cells.eq(3).text()},${$cells.eq(4).text()},${$cells.eq(5).text()},${$cells.eq(6).text()}\n`;
                });
                
                return csvContent;
            }
            
            // Download CSV file
            function downloadCSV(content, filename) {
                const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                
                const $link = $('<a>')
                    .attr('href', url)
                    .attr('download', filename)
                    .css('visibility', 'hidden');
                
                $('body').append($link);
                $link[0].click();
                $link.remove();
            }
        });
    </script>
</body>
</html>